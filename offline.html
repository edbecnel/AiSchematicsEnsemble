<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Schematics Ensemble — Offline</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      :root {
        color-scheme: light dark;
        --fg: #111827;
        --muted: #6b7280;
        --bg: #ffffff;
        --card: #f9fafb;
        --border: rgba(0, 0, 0, 0.18);
        --field-border: rgba(0, 0, 0, 0.25);
        --field-bg: rgba(127, 127, 127, 0.08);
        --btn-bg: rgba(127, 127, 127, 0.12);
        --btn-border: rgba(0, 0, 0, 0.25);
        --primary: #2563eb;
        --primary-fg: #ffffff;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --fg: #e5e7eb;
          --muted: #9ca3af;
          --bg: #0b1020;
          --card: #0f172a;
          --border: rgba(255, 255, 255, 0.18);
          --field-border: rgba(255, 255, 255, 0.22);
          --field-bg: rgba(127, 127, 127, 0.12);
          --btn-bg: rgba(127, 127, 127, 0.18);
          --btn-border: rgba(255, 255, 255, 0.22);
          --primary: #3b82f6;
          --primary-fg: #ffffff;
        }
      }

      html[data-theme="light"] {
        color-scheme: light;
        --fg: #111827;
        --muted: #6b7280;
        --bg: #ffffff;
        --card: #f9fafb;
        --border: rgba(0, 0, 0, 0.18);
        --field-border: rgba(0, 0, 0, 0.25);
        --field-bg: rgba(127, 127, 127, 0.08);
        --btn-bg: rgba(127, 127, 127, 0.12);
        --btn-border: rgba(0, 0, 0, 0.25);
        --primary: #2563eb;
        --primary-fg: #ffffff;
      }
      html[data-theme="dark"] {
        color-scheme: dark;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --bg: #0b1020;
        --card: #0f172a;
        --border: rgba(255, 255, 255, 0.18);
        --field-border: rgba(255, 255, 255, 0.22);
        --field-bg: rgba(127, 127, 127, 0.12);
        --btn-bg: rgba(127, 127, 127, 0.18);
        --btn-border: rgba(255, 255, 255, 0.22);
        --primary: #3b82f6;
        --primary-fg: #ffffff;
      }
      body {
        font-family:
          ui-sans-serif,
          system-ui,
          Segoe UI,
          Roboto,
          Arial;
        margin: 0;
        color: var(--fg);
        background: var(--bg);
      }
      header {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
      }
      main {
        padding: 18px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        background: var(--card);
      }
      .row {
        display: grid;
        grid-template-columns: minmax(0, 180px) minmax(0, 1fr);
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }
      .row > * {
        min-width: 0;
      }
      @media (max-width: 620px) {
        .row {
          grid-template-columns: 1fr;
        }
      }
      input[type="text"] {
        width: 100%;
        min-width: 0;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--field-border);
        background: var(--field-bg);
        color: inherit;
      }
      textarea {
        width: 100%;
        min-width: 0;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--field-bg);
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .hint {
        opacity: 0.75;
        font-size: 12px;
        color: var(--muted);
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      button {
        padding: 8px 12px;
        border: 1px solid var(--btn-border);
        background: var(--btn-bg);
        color: inherit;
        background: rgba(127, 127, 127, 0.12);
        cursor: pointer;
      }
      .btnLike {
        padding: 8px 12px;
        border: 1px solid var(--btn-border);
        background: var(--btn-bg);
        background: rgba(127, 127, 127, 0.12);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        user-select: none;
      }
        background: var(--primary);
        color: var(--primary-fg);
        border-color: var(--primary);
        border-color: #2563eb;

      .themeWrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .themeSelect {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--btn-border);
        background: var(--btn-bg);
        color: inherit;
      }
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .ok {
        color: #16a34a;
      }
      .warn {
        color: #d97706;
      }
      .err {
        color: #dc2626;
      }
    </style>
  </head>
  <body>
    <header>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: baseline;
          gap: 16px;
        "
      >
        <div>
          <div style="font-weight: 700">AI Schematics Ensemble — Offline</div>
          <div class="hint">
            Generates config JSON + copy/paste commands. Does not run anything.
          </div>
        </div>
        <div
          style="
            display: flex;
            gap: 12px;
            align-items: baseline;
            flex-wrap: wrap;
            justify-content: flex-end;
          "
        >
          <span class="themeWrap hint" title="Theme (defaults to System)">
            Theme
            <select id="themeSelect" class="themeSelect">
              <option value="system">System</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </span>
          <a class="hint" id="helpLink" href="offline-help.html"
            >Offline help</a
          >
          <a class="hint" href="cli-help.html">CLI install</a>
          <span class="hint" id="offlineHint"
            >Open this file directly (no server)</span
          >
        </div>
      </div>
    </header>

    <main>
      <div class="grid">
        <div class="card">
          <div style="font-weight: 700; margin-bottom: 8px">Inputs</div>
          <div class="row">
            <label>Question file</label>
            <div>
              <div style="display: flex; gap: 8px; align-items: center">
                <input
                  id="questionPath"
                  type="text"
                  value="examples/question.md"
                />
                <label class="btnLike" for="questionFile" title="Browse"
                  >...</label
                >
                <button
                  type="button"
                  id="questionClearBtn"
                  title="Clear"
                  style="padding: 8px 10px"
                >
                  ✕
                </button>
                <input
                  id="questionFile"
                  type="file"
                  accept=".md,.txt,text/plain,text/markdown"
                  style="
                    position: absolute;
                    left: -10000px;
                    width: 1px;
                    height: 1px;
                    opacity: 0;
                  "
                />
              </div>
              <div class="hint" id="questionPickedHint"></div>
            </div>
          </div>
          <div class="row">
            <label>Baseline netlist</label>
            <div>
              <div style="display: flex; gap: 8px; align-items: center">
                <input
                  id="baselineNetlistPath"
                  type="text"
                  value=""
                  placeholder="(optional)"
                />
                <label class="btnLike" for="baselineNetlistFile" title="Browse"
                  >...</label
                >
                <button
                  type="button"
                  id="baselineNetlistClearBtn"
                  title="Clear"
                  style="padding: 8px 10px"
                >
                  ✕
                </button>
                <input
                  id="baselineNetlistFile"
                  type="file"
                  accept=".cir,.sp,.lib,.txt,text/plain"
                  style="
                    position: absolute;
                    left: -10000px;
                    width: 1px;
                    height: 1px;
                    opacity: 0;
                  "
                />
              </div>
              <div class="hint" id="baselineNetlistPickedHint"></div>
            </div>
          </div>
          <div class="row">
            <label>Baseline image</label>
            <div>
              <div style="display: flex; gap: 8px; align-items: center">
                <input
                  id="baselineImagePath"
                  type="text"
                  value=""
                  placeholder="(optional)"
                />
                <label class="btnLike" for="baselineImageFile" title="Browse"
                  >...</label
                >
                <button
                  type="button"
                  id="baselineImageClearBtn"
                  title="Clear"
                  style="padding: 8px 10px"
                >
                  ✕
                </button>
                <input
                  id="baselineImageFile"
                  type="file"
                  accept="image/*"
                  style="
                    position: absolute;
                    left: -10000px;
                    width: 1px;
                    height: 1px;
                    opacity: 0;
                  "
                />
              </div>
              <div class="hint" id="baselineImagePickedHint"></div>
            </div>
          </div>
          <div class="row">
            <label>Outdir</label><input id="outdir" type="text" value="runs" />
          </div>
          <div class="row">
            <label>Bundle includes</label
            ><input
              id="bundleIncludes"
              type="text"
              value="false"
              placeholder="true/false"
            />
          </div>

          <div
            style="
              display: flex;
              align-items: baseline;
              justify-content: space-between;
              gap: 12px;
              font-weight: 700;
              margin: 14px 0 8px;
            "
          >
            <div>Models (optional)</div>
            <button
              type="button"
              id="keysOpenBtn"
              title="Open API keys (for generating commands)"
              style="padding: 8px 10px"
            >
              API Keys…
            </button>
          </div>
          <div class="row">
            <label>OpenAI model</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input id="openaiModel" type="text" value="gpt-5.2" />
              <button
                type="button"
                id="openaiKeyBtn"
                title="Enter OPENAI_API_KEY"
              >
                Keys
              </button>
            </div>
          </div>
          <div class="row">
            <label>Grok model</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input id="grokModel" type="text" value="grok-4" />
              <button type="button" id="xaiKeyBtn" title="Enter XAI_API_KEY">
                Keys
              </button>
            </div>
          </div>
          <div class="row">
            <label>Gemini model</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input id="geminiModel" type="text" value="gemini-2.5-flash" />
              <button
                type="button"
                id="geminiKeyBtn"
                title="Enter GEMINI_API_KEY"
              >
                Keys
              </button>
            </div>
          </div>
          <div class="row">
            <label>Claude model</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input
                id="claudeModel"
                type="text"
                value="claude-sonnet-4-5-20250929"
              />
              <button
                type="button"
                id="anthropicKeyBtn"
                title="Enter ANTHROPIC_API_KEY"
              >
                Keys
              </button>
            </div>
          </div>

          <div class="hint" style="margin-top: 8px">
            Note: offline mode cannot write <span class="mono">.env</span>. Keys
            entered here are used only to generate commands.
          </div>

          <div class="actions">
            <button class="primary" id="updateBtn">Update preview</button>
            <button id="saveLocalBtn">Save config to browser</button>
            <button id="loadLocalBtn">Load config from browser</button>
            <button id="downloadJsonBtn">Download JSON</button>
            <label
              class="hint"
              style="display: inline-flex; align-items: center; gap: 8px"
              >Import JSON
              <input id="importJsonInput" type="file" accept="application/json"
            /></label>
            <button id="clearLocalBtn">Clear saved config</button>
          </div>

          <div id="status" class="hint" style="margin-top: 10px">Idle.</div>
          <div class="hint" style="margin-top: 6px">
            Tip: put the downloaded JSON in your project folder, then run the
            command shown on the right.
          </div>
          <div class="hint" style="margin-top: 6px">
            Note: when you use the file picker, browsers do not provide a real
            file path. You may need to paste a path manually.
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 700; margin-bottom: 8px">
            Command preview
          </div>
          <div class="row">
            <label>Config filename</label
            ><input
              id="configFilename"
              type="text"
              value="ai-schematics.config.json"
            />
          </div>
          <div class="hint" style="margin: 8px 0">Two options:</div>
          <div class="hint">A) Run using JSON config</div>
          <textarea id="cmdJson" rows="4" readonly></textarea>
          <div class="actions">
            <button id="copyJsonPsBtn">Copy (PowerShell)</button>
            <button id="copyJsonCmdBtn">Copy (cmd.exe)</button>
          </div>

          <div class="hint" style="margin: 12px 0 6px">
            B) Run using explicit parameters
          </div>
          <textarea id="cmdExplicit" rows="7" readonly></textarea>
          <div class="actions">
            <button id="copyExplicitPsBtn">Copy (PowerShell)</button>
            <button id="copyExplicitCmdBtn">Copy (cmd.exe)</button>
          </div>

          <div class="hint" style="margin: 12px 0 6px">
            C) Interactive chat (ask questions in the CLI)
          </div>
          <div class="row">
            <label>Chat provider</label>
            <select id="chatProvider">
              <option value="openai">openai</option>
              <option value="xai">xai</option>
              <option value="google">google</option>
              <option value="anthropic">anthropic</option>
              <option value="ensemble">ensemble</option>
            </select>
          </div>
          <div class="row">
            <label>Max history</label>
            <input
              id="chatMaxHistory"
              type="number"
              min="0"
              max="50"
              value="10"
            />
          </div>
          <div class="row">
            <label>Save transcript</label>
            <label style="display: inline-flex; align-items: center; gap: 8px">
              <input id="chatSave" type="checkbox" />
              <span class="hint"
                >Saves to <span class="mono">outdir</span></span
              >
            </label>
          </div>
          <textarea id="cmdChat" rows="7" readonly></textarea>
          <div class="actions">
            <button id="copyChatPsBtn">Copy (PowerShell)</button>
            <button id="copyChatCmdBtn">Copy (cmd.exe)</button>
          </div>

          <div class="hint" style="margin-top: 10px">
            Commands assume you run them from the project root (folder
            containing <code>package.json</code>), after
            <code>npm run build</code>.
          </div>
        </div>
      </div>
    </main>

    <div
      id="keysModal"
      style="
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.55);
        padding: 16px;
      "
    >
      <div
        style="
          width: min(780px, 100%);
          background: rgba(20, 20, 20, 0.92);
          border: 1px solid rgba(127, 127, 127, 0.35);
          border-radius: 14px;
          padding: 14px;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
          "
        >
          <div style="font-weight: 700">API Keys (offline)</div>
          <button
            type="button"
            id="keysCloseBtn"
            title="Close"
            style="padding: 8px 10px"
          >
            ✕
          </button>
        </div>
        <div class="hint" style="margin: 6px 0 12px">
          These keys are stored in your browser storage and used only to
          generate commands.
        </div>

        <div>
          <div class="row">
            <label>OPENAI_API_KEY</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input
                id="envOpenai"
                type="text"
                placeholder="(optional)"
                autocomplete="off"
                spellcheck="false"
                style="-webkit-text-security: disc"
              /><button type="button" id="showOpenai">Show</button>
            </div>
          </div>
          <div class="row">
            <label>XAI_API_KEY</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input
                id="envXai"
                type="text"
                placeholder="(optional)"
                autocomplete="off"
                spellcheck="false"
                style="-webkit-text-security: disc"
              /><button type="button" id="showXai">Show</button>
            </div>
          </div>
          <div class="row">
            <label>GEMINI_API_KEY</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input
                id="envGemini"
                type="text"
                placeholder="(optional)"
                autocomplete="off"
                spellcheck="false"
                style="-webkit-text-security: disc"
              /><button type="button" id="showGemini">Show</button>
            </div>
          </div>
          <div class="row">
            <label>ANTHROPIC_API_KEY</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <input
                id="envAnthropic"
                type="text"
                placeholder="(optional)"
                autocomplete="off"
                spellcheck="false"
                style="-webkit-text-security: disc"
              /><button type="button" id="showAnthropic">Show</button>
            </div>
          </div>
        </div>

        <div class="actions" style="margin-top: 12px">
          <button type="button" class="primary" id="keysSaveBtn">
            Save to browser
          </button>
          <button
            type="button"
            id="keysBrowseEnvFileBtn"
            title="Load keys from a local .env file on your computer"
          >
            Browse… .env
          </button>
          <input
            id="keysEnvFileInput"
            type="file"
            accept=".env,text/plain"
            style="display: none"
          />
          <button
            type="button"
            id="keysLoadEnvBtn"
            style="display: none"
            title="Loads keys from the project's .env via the local UI server"
          >
            Load from .env
          </button>
          <button type="button" id="keysClearBtn">Clear browser keys</button>
          <span class="hint" id="keysStatus" style="align-self: center"></span>
        </div>
      </div>
    </div>

    <script>
      const THEME_KEY = "ai-schematics-theme-v1";
      const KEY = "ai-schematics-offline-config-v1";
      const KEYS_KEY = "ai-schematics-offline-keys-v1";

      const els = {
        questionPath: document.getElementById("questionPath"),
        baselineNetlistPath: document.getElementById("baselineNetlistPath"),
        baselineImagePath: document.getElementById("baselineImagePath"),
        questionFile: document.getElementById("questionFile"),
        baselineNetlistFile: document.getElementById("baselineNetlistFile"),
        baselineImageFile: document.getElementById("baselineImageFile"),
        questionClearBtn: document.getElementById("questionClearBtn"),
        baselineNetlistClearBtn: document.getElementById(
          "baselineNetlistClearBtn",
        ),
        baselineImageClearBtn: document.getElementById("baselineImageClearBtn"),
        questionPickedHint: document.getElementById("questionPickedHint"),
        baselineNetlistPickedHint: document.getElementById(
          "baselineNetlistPickedHint",
        ),
        baselineImagePickedHint: document.getElementById(
          "baselineImagePickedHint",
        ),
        outdir: document.getElementById("outdir"),
        bundleIncludes: document.getElementById("bundleIncludes"),
        openaiModel: document.getElementById("openaiModel"),
        grokModel: document.getElementById("grokModel"),
        geminiModel: document.getElementById("geminiModel"),
        claudeModel: document.getElementById("claudeModel"),
        openaiKeyBtn: document.getElementById("openaiKeyBtn"),
        xaiKeyBtn: document.getElementById("xaiKeyBtn"),
        geminiKeyBtn: document.getElementById("geminiKeyBtn"),
        anthropicKeyBtn: document.getElementById("anthropicKeyBtn"),
        configFilename: document.getElementById("configFilename"),
        cmdJson: document.getElementById("cmdJson"),
        cmdExplicit: document.getElementById("cmdExplicit"),
        cmdChat: document.getElementById("cmdChat"),
        status: document.getElementById("status"),
        updateBtn: document.getElementById("updateBtn"),
        saveLocalBtn: document.getElementById("saveLocalBtn"),
        loadLocalBtn: document.getElementById("loadLocalBtn"),
        downloadJsonBtn: document.getElementById("downloadJsonBtn"),
        importJsonInput: document.getElementById("importJsonInput"),
        clearLocalBtn: document.getElementById("clearLocalBtn"),
        copyJsonPsBtn: document.getElementById("copyJsonPsBtn"),
        copyJsonCmdBtn: document.getElementById("copyJsonCmdBtn"),
        copyExplicitPsBtn: document.getElementById("copyExplicitPsBtn"),
        copyExplicitCmdBtn: document.getElementById("copyExplicitCmdBtn"),
        copyChatPsBtn: document.getElementById("copyChatPsBtn"),
        copyChatCmdBtn: document.getElementById("copyChatCmdBtn"),
        chatProvider: document.getElementById("chatProvider"),
        chatMaxHistory: document.getElementById("chatMaxHistory"),
        chatSave: document.getElementById("chatSave"),
      };

      const keysUi = {
        modal: document.getElementById("keysModal"),
        closeBtn: document.getElementById("keysCloseBtn"),
        saveBtn: document.getElementById("keysSaveBtn"),
        browseEnvFileBtn: document.getElementById("keysBrowseEnvFileBtn"),
        envFileInput: document.getElementById("keysEnvFileInput"),
        loadEnvBtn: document.getElementById("keysLoadEnvBtn"),
        clearBtn: document.getElementById("keysClearBtn"),
        status: document.getElementById("keysStatus"),
        envOpenai: document.getElementById("envOpenai"),
        envXai: document.getElementById("envXai"),
        envGemini: document.getElementById("envGemini"),
        envAnthropic: document.getElementById("envAnthropic"),
        showOpenai: document.getElementById("showOpenai"),
        showXai: document.getElementById("showXai"),
        showGemini: document.getElementById("showGemini"),
        showAnthropic: document.getElementById("showAnthropic"),
      };

      const headerEls = {
        helpLink: document.getElementById("helpLink"),
        offlineHint: document.getElementById("offlineHint"),
        themeSelect: document.getElementById("themeSelect"),
      };

      const IS_SERVER =
        location.protocol === "http:" || location.protocol === "https:";

      function applyThemeChoice(choice) {
        const c = String(choice || "").toLowerCase();
        if (c === "dark" || c === "light") {
          document.documentElement.dataset.theme = c;
        } else {
          // System default
          try {
            delete document.documentElement.dataset.theme;
          } catch {
            document.documentElement.removeAttribute("data-theme");
          }
        }
      }

      function loadTheme() {
        try {
          const saved = localStorage.getItem(THEME_KEY);
          if (headerEls.themeSelect) {
            headerEls.themeSelect.value = saved || "system";
          }
          applyThemeChoice(saved || "system");
        } catch {
          if (headerEls.themeSelect) headerEls.themeSelect.value = "system";
          applyThemeChoice("system");
        }
      }

      function saveTheme(choice) {
        const c = String(choice || "system").toLowerCase();
        try {
          if (c === "dark" || c === "light") localStorage.setItem(THEME_KEY, c);
          else localStorage.removeItem(THEME_KEY);
        } catch {
          // ignore
        }
        applyThemeChoice(c);
      }

      function clean(s) {
        const t = String(s ?? "").trim();
        return t ? t : "";
      }

      function asBool(s) {
        const t = clean(s).toLowerCase();
        return t === "true" || t === "1" || t === "yes" || t === "y";
      }

      function getConfig() {
        return {
          questionPath: clean(els.questionPath.value),
          baselineNetlistPath: clean(els.baselineNetlistPath.value),
          baselineImagePath: clean(els.baselineImagePath.value),
          outdir: clean(els.outdir.value),
          bundleIncludes: asBool(els.bundleIncludes.value),
          openaiModel: clean(els.openaiModel.value),
          grokModel: clean(els.grokModel.value),
          geminiModel: clean(els.geminiModel.value),
          claudeModel: clean(els.claudeModel.value),
        };
      }

      function setStatus(kind, msg) {
        els.status.className =
          kind === "ok"
            ? "ok"
            : kind === "warn"
              ? "warn"
              : kind === "err"
                ? "err"
                : "hint";
        els.status.textContent = msg;
      }

      function setPickedHint(el, msg) {
        if (!el) return;
        el.textContent = msg || "";
      }

      function uploadToServer(file, kind) {
        return new Promise((resolve, reject) => {
          try {
            const fd = new FormData();
            // Use XHR here for maximum browser compatibility and to avoid
            // boundary-related issues from any fetch wrappers/extensions.
            fd.append("file", file, file.name);

            const xhr = new XMLHttpRequest();
            const u = new URL("/api/upload", location.href);
            if (kind) u.searchParams.set("kind", String(kind));
            xhr.open("POST", String(u), true);
            xhr.onload = () => {
              const status = xhr.status || 0;
              const text = xhr.responseText || "";
              let parsed;
              try {
                parsed = text ? JSON.parse(text) : {};
              } catch {
                parsed = { error: text || "Invalid JSON response" };
              }
              if (status >= 200 && status < 300) {
                resolve(parsed);
              } else {
                reject(new Error(String(parsed?.error || "HTTP " + status)));
              }
            };
            xhr.onerror = () => {
              reject(new Error("Network error"));
            };
            xhr.send(fd);
          } catch (e) {
            reject(e);
          }
        });
      }

      async function uploadToServerRaw(file, kind) {
        const ab = await file.arrayBuffer();
        const u = new URL("/api/upload", location.href);
        u.searchParams.set("filename", file.name || "upload");
        if (kind) u.searchParams.set("kind", String(kind));
        const resp = await fetch(String(u), {
          method: "POST",
          headers: {
            "content-type": "application/octet-stream",
            "x-filename": file.name || "upload",
          },
          body: ab,
        });
        const text = await resp.text();
        let j;
        try {
          j = text ? JSON.parse(text) : {};
        } catch {
          j = { error: text || "Invalid JSON response" };
        }
        if (!resp.ok)
          throw new Error(String(j?.error || "HTTP " + resp.status));
        return j;
      }

      let __uploadApiKnown = null;
      async function hasUploadApi() {
        if (__uploadApiKnown === true || __uploadApiKnown === false)
          return __uploadApiKnown;
        const isHttp =
          location.protocol === "http:" || location.protocol === "https:";
        if (!isHttp) {
          __uploadApiKnown = false;
          return false;
        }
        try {
          const resp = await fetch("/api/health", { cache: "no-store" });
          if (!resp.ok) {
            __uploadApiKnown = false;
            return false;
          }
          const j = await resp.json().catch(() => ({}));
          __uploadApiKnown = Boolean(j && j.ok);
          return __uploadApiKnown;
        } catch {
          __uploadApiKnown = false;
          return false;
        }
      }

      async function pickFile(kind) {
        let fileEl, pathEl, hintEl;
        if (kind === "question") {
          fileEl = els.questionFile;
          pathEl = els.questionPath;
          hintEl = els.questionPickedHint;
        } else if (kind === "baselineNetlist") {
          fileEl = els.baselineNetlistFile;
          pathEl = els.baselineNetlistPath;
          hintEl = els.baselineNetlistPickedHint;
        } else {
          fileEl = els.baselineImageFile;
          pathEl = els.baselineImagePath;
          hintEl = els.baselineImagePickedHint;
        }
        const f = fileEl && fileEl.files && fileEl.files[0];
        if (!f) return;

        const canUpload = await hasUploadApi();
        if (canUpload) {
          setStatus("hint", "Uploading " + f.name + "...");
          uploadToServer(f, kind)
            .then((j) => {
              const saved = String(j?.path || "");
              if (!saved) throw new Error("Upload response missing path");
              pathEl.value = saved;
              setPickedHint(hintEl, "Picked: " + f.name + " (uploaded)");
              setStatus("ok", "Uploaded. (Snapshot — re-upload after edits.)");
              updatePreview();
            })
            .catch(async (e) => {
              const msg = String(e?.message || e);
              try {
                // If multipart got blocked/interfered with, retry using raw bytes.
                setStatus("hint", "Upload failed; retrying raw upload...");
                const j2 = await uploadToServerRaw(f, kind);
                const saved2 = String(j2?.path || "");
                if (!saved2) throw new Error("Upload response missing path");
                pathEl.value = saved2;
                setPickedHint(hintEl, "Picked: " + f.name + " (uploaded)");
                setStatus(
                  "ok",
                  "Uploaded. (Snapshot — re-upload after edits.)",
                );
                updatePreview();
                return;
              } catch (e2) {
                // Final fallback to filename
                pathEl.value = f.name;
                setPickedHint(
                  hintEl,
                  "Picked: " + f.name + " (paste real path if needed)",
                );
                const msg2 = String(e2?.message || e2);
                setStatus(
                  "warn",
                  "Upload failed; using filename only: " + msg + " | " + msg2,
                );
                try {
                  console.warn("Upload failed:", msg, msg2);
                } catch {
                  // ignore
                }
                updatePreview();
              }
            });
          return;
        }

        // No local UI server available (e.g., GitHub Pages) or opened directly (file://):
        // browser security means we do not get a real local path.
        pathEl.value = f.name;
        setPickedHint(
          hintEl,
          "Picked: " +
            f.name +
            " (browser can’t reveal full path; paste a real path or run the UI server)",
        );
        setStatus(
          "warn",
          "This page can’t discover your full local file path. Paste the full path (or use a relative path) or run: npm run ui",
        );
        updatePreview();
      }

      function clearPicked(kind) {
        if (kind === "question") {
          els.questionPath.value = "";
          if (els.questionFile) els.questionFile.value = "";
          setPickedHint(els.questionPickedHint, "");
        } else if (kind === "baselineNetlist") {
          els.baselineNetlistPath.value = "";
          if (els.baselineNetlistFile) els.baselineNetlistFile.value = "";
          setPickedHint(els.baselineNetlistPickedHint, "");
        } else {
          els.baselineImagePath.value = "";
          if (els.baselineImageFile) els.baselineImageFile.value = "";
          setPickedHint(els.baselineImagePickedHint, "");
        }
        updatePreview();
      }

      function setKeysStatus(msg, kind) {
        if (!keysUi.status) return;
        keysUi.status.textContent = msg || "";
        keysUi.status.className =
          kind === "ok"
            ? "ok"
            : kind === "err"
              ? "err"
              : kind === "warn"
                ? "warn"
                : "hint";
      }

      function setPasswordToggle(btn, input) {
        if (!btn || !input) return;
        btn.addEventListener("click", () => {
          const masked = (input.style.webkitTextSecurity || "disc") !== "none";
          input.style.webkitTextSecurity = masked ? "none" : "disc";
          btn.textContent = masked ? "Hide" : "Show";
        });
      }

      function hasAnyKeyValue() {
        return Boolean(
          (keysUi.envOpenai && clean(keysUi.envOpenai.value)) ||
          (keysUi.envXai && clean(keysUi.envXai.value)) ||
          (keysUi.envGemini && clean(keysUi.envGemini.value)) ||
          (keysUi.envAnthropic && clean(keysUi.envAnthropic.value)),
        );
      }

      function canUseLocalStorage() {
        try {
          const k = "__ls_test__" + String(Date.now());
          localStorage.setItem(k, "1");
          localStorage.removeItem(k);
          return true;
        } catch {
          return false;
        }
      }

      function loadKeys() {
        try {
          if (!canUseLocalStorage()) {
            setKeysStatus(
              "Browser storage is blocked; keys cannot be saved/loaded locally.",
              "warn",
            );
            return;
          }
          const raw = localStorage.getItem(KEYS_KEY);
          if (!raw) {
            setKeysStatus(
              IS_SERVER
                ? "No keys saved in browser. Use 'Load from .env' or paste keys."
                : "No keys saved in browser. Paste keys, or use 'Browse .env', then click 'Save to browser'.",
              "hint",
            );
            return;
          }
          const k = JSON.parse(raw);
          if (keysUi.envOpenai)
            keysUi.envOpenai.value = String(k.OPENAI_API_KEY || "");
          if (keysUi.envXai) keysUi.envXai.value = String(k.XAI_API_KEY || "");
          if (keysUi.envGemini)
            keysUi.envGemini.value = String(k.GEMINI_API_KEY || "");
          if (keysUi.envAnthropic)
            keysUi.envAnthropic.value = String(k.ANTHROPIC_API_KEY || "");

          const nonEmpty =
            (keysUi.envOpenai?.value ? 1 : 0) +
            (keysUi.envXai?.value ? 1 : 0) +
            (keysUi.envGemini?.value ? 1 : 0) +
            (keysUi.envAnthropic?.value ? 1 : 0);
          setKeysStatus(
            nonEmpty
              ? `Loaded ${nonEmpty} key(s) from browser storage.`
              : "Loaded keys (all empty).",
            "hint",
          );
        } catch {
          setKeysStatus("Failed to load keys from browser storage.", "warn");
        }
      }

      async function loadKeysFromEnv() {
        if (!IS_SERVER) return;
        try {
          setKeysStatus("Loading keys from .env...", "hint");
          const resp = await fetch("/api/env", { cache: "no-store" });
          const j = await resp.json();
          if (!resp.ok || !j?.ok)
            throw new Error(String(j?.error || "HTTP " + resp.status));
          const k = j?.keys || {};
          if (keysUi.envOpenai)
            keysUi.envOpenai.value = String(k.OPENAI_API_KEY || "");
          if (keysUi.envXai) keysUi.envXai.value = String(k.XAI_API_KEY || "");
          if (keysUi.envGemini)
            keysUi.envGemini.value = String(k.GEMINI_API_KEY || "");
          if (keysUi.envAnthropic)
            keysUi.envAnthropic.value = String(k.ANTHROPIC_API_KEY || "");
          setKeysStatus(
            "Loaded keys from .env (not saved to browser storage).",
            "ok",
          );
          updatePreview();
        } catch (e) {
          setKeysStatus(
            "Load from .env failed: " + String(e?.message || e),
            "err",
          );
        }
      }

      function parseDotenv(text) {
        const out = {};
        const lines = String(text || "")
          .replace(/\r\n/g, "\n")
          .split("\n");
        for (let rawLine of lines) {
          let line = String(rawLine || "");
          if (!line) continue;
          // Strip UTF-8 BOM
          if (line.charCodeAt(0) === 0xfeff) line = line.slice(1);
          line = line.trim();
          if (!line || line.startsWith("#")) continue;
          if (line.startsWith("export ")) line = line.slice("export ".length);

          const eq = line.indexOf("=");
          if (eq <= 0) continue;
          const key = line.slice(0, eq).trim();
          let val = line.slice(eq + 1).trim();
          if (!key) continue;

          // Remove inline comments for unquoted values: FOO=bar # comment
          if (val && val[0] !== '"' && val[0] !== "'") {
            const hash = val.indexOf("#");
            if (hash >= 0) val = val.slice(0, hash).trim();
          }

          // Unquote
          if (
            (val.startsWith('"') && val.endsWith('"')) ||
            (val.startsWith("'") && val.endsWith("'"))
          ) {
            val = val.slice(1, -1);
          }

          // Common escapes
          val = val.replace(/\\n/g, "\n").replace(/\\r/g, "\r");

          out[key] = val;
        }
        return out;
      }

      function applyKeysFromEnvMap(map, sourceLabel) {
        const k = map || {};
        let applied = 0;

        if (keysUi.envOpenai && typeof k.OPENAI_API_KEY === "string") {
          keysUi.envOpenai.value = k.OPENAI_API_KEY;
          applied += k.OPENAI_API_KEY ? 1 : 0;
        }
        if (keysUi.envXai && typeof k.XAI_API_KEY === "string") {
          keysUi.envXai.value = k.XAI_API_KEY;
          applied += k.XAI_API_KEY ? 1 : 0;
        }
        if (keysUi.envGemini && typeof k.GEMINI_API_KEY === "string") {
          keysUi.envGemini.value = k.GEMINI_API_KEY;
          applied += k.GEMINI_API_KEY ? 1 : 0;
        }
        if (keysUi.envAnthropic && typeof k.ANTHROPIC_API_KEY === "string") {
          keysUi.envAnthropic.value = k.ANTHROPIC_API_KEY;
          applied += k.ANTHROPIC_API_KEY ? 1 : 0;
        }

        setKeysStatus(
          applied
            ? `Loaded ${applied} key(s) from ${sourceLabel} (not yet saved).`
            : `Loaded from ${sourceLabel} (no matching keys found).`,
          applied ? "ok" : "warn",
        );
        updatePreview();
      }

      async function loadKeysFromLocalEnvFile(file) {
        try {
          if (!file) return;
          setKeysStatus(`Reading ${file.name}...`, "hint");
          const text = await file.text();
          const map = parseDotenv(text);
          applyKeysFromEnvMap(map, file.name);
        } catch (e) {
          setKeysStatus(
            "Failed to read .env: " + String(e?.message || e),
            "err",
          );
        }
      }

      function saveKeys() {
        try {
          const payload = {
            OPENAI_API_KEY: keysUi.envOpenai ? keysUi.envOpenai.value : "",
            XAI_API_KEY: keysUi.envXai ? keysUi.envXai.value : "",
            GEMINI_API_KEY: keysUi.envGemini ? keysUi.envGemini.value : "",
            ANTHROPIC_API_KEY: keysUi.envAnthropic
              ? keysUi.envAnthropic.value
              : "",
          };
          localStorage.setItem(KEYS_KEY, JSON.stringify(payload));
          setKeysStatus("Saved to browser storage.", "ok");
          updatePreview();
        } catch (e) {
          setKeysStatus("Save failed: " + String(e?.message || e), "err");
        }
      }

      function clearKeys() {
        try {
          localStorage.removeItem(KEYS_KEY);
        } catch {
          // ignore
        }
        if (keysUi.envOpenai) keysUi.envOpenai.value = "";
        if (keysUi.envXai) keysUi.envXai.value = "";
        if (keysUi.envGemini) keysUi.envGemini.value = "";
        if (keysUi.envAnthropic) keysUi.envAnthropic.value = "";
        setKeysStatus("Cleared browser-saved keys.", "ok");
        updatePreview();
      }

      function openKeysModal(focus) {
        if (!keysUi.modal) return;
        keysUi.modal.style.display = "flex";
        setKeysStatus("", "hint");
        loadKeys();
        if (IS_SERVER && !hasAnyKeyValue()) {
          // Auto-load from .env for convenience if no browser-saved keys exist.
          loadKeysFromEnv();
        }
        const focusMap = {
          openai: keysUi.envOpenai,
          xai: keysUi.envXai,
          gemini: keysUi.envGemini,
          anthropic: keysUi.envAnthropic,
        };
        const el = focusMap[focus];
        if (el && el.focus) setTimeout(() => el.focus(), 50);
      }

      function closeKeysModal() {
        if (!keysUi.modal) return;
        keysUi.modal.style.display = "none";
      }

      function quoteCmd(arg) {
        const s = String(arg);
        if (!s) return '""';
        if (!/[\s"]/g.test(s)) return s;
        return '"' + s.replace(/"/g, '\\"') + '"';
      }

      function quotePs(arg) {
        // PowerShell: double-quote, escape embedded quotes with backtick
        const s = String(arg);
        if (!s) return '""';
        if (!/[\s"]/g.test(s)) return s;
        return '"' + s.replace(/"/g, '`"') + '"';
      }

      function buildArgs(cfg, q) {
        const args = [];
        args.push("--question", q(cfg.questionPath));
        if (cfg.baselineNetlistPath)
          args.push("--baseline-netlist", q(cfg.baselineNetlistPath));
        if (cfg.baselineImagePath)
          args.push("--baseline-image", q(cfg.baselineImagePath));
        if (cfg.bundleIncludes) args.push("--bundle-includes");
        if (cfg.outdir) args.push("--outdir", q(cfg.outdir));
        if (cfg.openaiModel) args.push("--openai-model", q(cfg.openaiModel));
        if (cfg.grokModel) args.push("--grok-model", q(cfg.grokModel));
        if (cfg.geminiModel) args.push("--gemini-model", q(cfg.geminiModel));
        if (cfg.claudeModel) args.push("--claude-model", q(cfg.claudeModel));
        return args;
      }

      function buildChatArgs(cfg, q) {
        // `chat` CLI uses baseline context + models (no --question, no --bundle-includes).
        const args = [];
        if (cfg.baselineNetlistPath)
          args.push("--baseline-netlist", q(cfg.baselineNetlistPath));
        if (cfg.baselineImagePath)
          args.push("--baseline-image", q(cfg.baselineImagePath));
        if (cfg.openaiModel) args.push("--openai-model", q(cfg.openaiModel));
        if (cfg.grokModel) args.push("--grok-model", q(cfg.grokModel));
        if (cfg.geminiModel) args.push("--gemini-model", q(cfg.geminiModel));
        if (cfg.claudeModel) args.push("--claude-model", q(cfg.claudeModel));
        return args;
      }

      function getKeys() {
        return {
          OPENAI_API_KEY: keysUi.envOpenai ? clean(keysUi.envOpenai.value) : "",
          XAI_API_KEY: keysUi.envXai ? clean(keysUi.envXai.value) : "",
          GEMINI_API_KEY: keysUi.envGemini ? clean(keysUi.envGemini.value) : "",
          ANTHROPIC_API_KEY: keysUi.envAnthropic
            ? clean(keysUi.envAnthropic.value)
            : "",
        };
      }

      function prefixPs(keys) {
        const parts = [];
        if (keys.OPENAI_API_KEY)
          parts.push("$env:OPENAI_API_KEY=" + quotePs(keys.OPENAI_API_KEY));
        if (keys.XAI_API_KEY)
          parts.push("$env:XAI_API_KEY=" + quotePs(keys.XAI_API_KEY));
        if (keys.GEMINI_API_KEY)
          parts.push("$env:GEMINI_API_KEY=" + quotePs(keys.GEMINI_API_KEY));
        if (keys.ANTHROPIC_API_KEY)
          parts.push(
            "$env:ANTHROPIC_API_KEY=" + quotePs(keys.ANTHROPIC_API_KEY),
          );
        return parts.length ? parts.join("; ") + "; " : "";
      }

      function prefixCmd(keys) {
        const parts = [];
        if (keys.OPENAI_API_KEY)
          parts.push("set OPENAI_API_KEY=" + keys.OPENAI_API_KEY);
        if (keys.XAI_API_KEY) parts.push("set XAI_API_KEY=" + keys.XAI_API_KEY);
        if (keys.GEMINI_API_KEY)
          parts.push("set GEMINI_API_KEY=" + keys.GEMINI_API_KEY);
        if (keys.ANTHROPIC_API_KEY)
          parts.push("set ANTHROPIC_API_KEY=" + keys.ANTHROPIC_API_KEY);
        return parts.length ? parts.join(" && ") + " && " : "";
      }

      function updatePreview() {
        const cfg = getConfig();
        if (!cfg.questionPath) {
          setStatus(
            "warn",
            "Question file is required (for both config + explicit commands).",
          );
        } else {
          setStatus("hint", "Preview updated.");
        }

        const configFile =
          clean(els.configFilename.value) || "ai-schematics.config.json";

        const basePs = ["node", "dist/index.js", "run", "--no-prompts"];
        const baseCmd = ["node", "dist\\index.js", "run", "--no-prompts"];

        const baseChatPs = ["node", "dist/index.js", "chat"];
        const baseChatCmd = ["node", "dist\\index.js", "chat"];

        const keys = getKeys();
        const psPrefix = prefixPs(keys);
        const cmdPrefix = prefixCmd(keys);

        // JSON-config command
        els.cmdJson.value =
          "PowerShell:\n" +
          psPrefix +
          [...basePs, "--config", quotePs(configFile)].join(" ") +
          "\n\ncmd.exe:\n" +
          cmdPrefix +
          [...baseCmd, "--config", quoteCmd(configFile)].join(" ");

        // Explicit command
        const argsPs = buildArgs(cfg, quotePs);
        const argsCmd = buildArgs(cfg, quoteCmd);
        els.cmdExplicit.value =
          "PowerShell:\n" +
          psPrefix +
          [...basePs, ...argsPs].join(" ") +
          "\n\ncmd.exe:\n" +
          cmdPrefix +
          [...baseCmd, ...argsCmd].join(" ");

        // Interactive chat command
        const chatProvider = clean(els.chatProvider?.value) || "openai";
        const maxHistory = clean(els.chatMaxHistory?.value) || "10";
        const chatSave = Boolean(els.chatSave && els.chatSave.checked);

        const chatArgsPs = [
          "--provider",
          quotePs(chatProvider),
          "--max-history",
          quotePs(maxHistory),
          ...buildChatArgs(cfg, quotePs),
        ];
        const chatArgsCmd = [
          "--provider",
          quoteCmd(chatProvider),
          "--max-history",
          quoteCmd(maxHistory),
          ...buildChatArgs(cfg, quoteCmd),
        ];

        if (chatSave) {
          chatArgsPs.push("--save");
          chatArgsCmd.push("--save");
          if (cfg.outdir) {
            chatArgsPs.push("--outdir", quotePs(cfg.outdir));
            chatArgsCmd.push("--outdir", quoteCmd(cfg.outdir));
          }
        }

        els.cmdChat.value =
          "PowerShell:\n" +
          psPrefix +
          [...baseChatPs, ...chatArgsPs].join(" ") +
          "\n\ncmd.exe:\n" +
          cmdPrefix +
          [...baseChatCmd, ...chatArgsCmd].join(" ");
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          setStatus("ok", "Copied to clipboard.");
        } catch {
          // Fallback for environments where Clipboard API is blocked.
          try {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.setAttribute("readonly", "");
            ta.style.position = "fixed";
            ta.style.left = "-10000px";
            ta.style.top = "0";
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand && document.execCommand("copy");
            document.body.removeChild(ta);
            if (ok) {
              setStatus("ok", "Copied to clipboard.");
              return;
            }
          } catch {
            // ignore
          }
          setStatus(
            "err",
            "Clipboard copy failed. Select the text and copy manually.",
          );
        }
      }

      function downloadJson() {
        const cfg = getConfig();
        const fname =
          clean(els.configFilename.value) || "ai-schematics.config.json";
        const blob = new Blob([JSON.stringify(cfg, null, 2)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        a.click();
        URL.revokeObjectURL(a.href);
        setStatus("ok", "Downloaded JSON config: " + fname);
      }

      function saveLocal() {
        try {
          localStorage.setItem(KEY, JSON.stringify(getConfig(), null, 2));
          setStatus("ok", "Saved config to this browser.");
        } catch (e) {
          setStatus(
            "err",
            "Save failed (localStorage blocked): " + String(e?.message || e),
          );
        }
      }

      function loadLocal() {
        let raw = "";
        try {
          raw = localStorage.getItem(KEY) || "";
        } catch (e) {
          setStatus(
            "err",
            "Load failed (localStorage blocked): " + String(e?.message || e),
          );
          return;
        }
        if (!raw)
          return setStatus("warn", "No saved config found in this browser.");
        try {
          const cfg = JSON.parse(raw);
          els.questionPath.value = cfg.questionPath || "";
          els.baselineNetlistPath.value = cfg.baselineNetlistPath || "";
          els.baselineImagePath.value = cfg.baselineImagePath || "";
          els.outdir.value = cfg.outdir || "runs";
          els.bundleIncludes.value = String(Boolean(cfg.bundleIncludes));
          els.openaiModel.value = cfg.openaiModel || "";
          els.grokModel.value = cfg.grokModel || "";
          els.geminiModel.value = cfg.geminiModel || "";
          els.claudeModel.value = cfg.claudeModel || "";
          setStatus("ok", "Loaded saved config.");
          updatePreview();
        } catch (e) {
          setStatus(
            "err",
            "Failed to parse saved config: " + String(e?.message || e),
          );
        }
      }

      function clearLocal() {
        try {
          localStorage.removeItem(KEY);
          setStatus("ok", "Cleared saved config.");
        } catch (e) {
          setStatus(
            "err",
            "Clear failed (localStorage blocked): " + String(e?.message || e),
          );
        }
      }

      async function importJson(file) {
        const text = await file.text();
        const cfg = JSON.parse(text);
        els.questionPath.value = cfg.questionPath || "";
        els.baselineNetlistPath.value = cfg.baselineNetlistPath || "";
        els.baselineImagePath.value = cfg.baselineImagePath || "";
        els.outdir.value = cfg.outdir || "runs";
        els.bundleIncludes.value = String(Boolean(cfg.bundleIncludes));
        els.openaiModel.value = cfg.openaiModel || "";
        els.grokModel.value = cfg.grokModel || "";
        els.geminiModel.value = cfg.geminiModel || "";
        els.claudeModel.value = cfg.claudeModel || "";
        setStatus("ok", "Imported config JSON.");
        updatePreview();
      }

      els.updateBtn.addEventListener("click", updatePreview);
      els.saveLocalBtn.addEventListener("click", saveLocal);
      els.loadLocalBtn.addEventListener("click", loadLocal);
      els.clearLocalBtn.addEventListener("click", clearLocal);
      els.downloadJsonBtn.addEventListener("click", downloadJson);
      els.importJsonInput.addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) importJson(f);
      });

      els.copyJsonPsBtn.addEventListener("click", () =>
        copyText(
          els.cmdJson.value
            .split("\n\ncmd.exe:")[0]
            .replace("PowerShell:\n", ""),
        ),
      );
      els.copyJsonCmdBtn.addEventListener("click", () =>
        copyText(els.cmdJson.value.split("\n\ncmd.exe:\n")[1] || ""),
      );
      els.copyExplicitPsBtn.addEventListener("click", () =>
        copyText(
          els.cmdExplicit.value
            .split("\n\ncmd.exe:")[0]
            .replace("PowerShell:\n", ""),
        ),
      );
      els.copyExplicitCmdBtn.addEventListener("click", () =>
        copyText(els.cmdExplicit.value.split("\n\ncmd.exe:\n")[1] || ""),
      );

      if (els.chatProvider)
        els.chatProvider.addEventListener("change", updatePreview);
      if (els.chatMaxHistory)
        els.chatMaxHistory.addEventListener("input", updatePreview);
      if (els.chatSave) els.chatSave.addEventListener("change", updatePreview);

      els.copyChatPsBtn.addEventListener("click", () =>
        copyText(
          els.cmdChat.value
            .split("\n\ncmd.exe:")[0]
            .replace("PowerShell:\n", ""),
        ),
      );
      els.copyChatCmdBtn.addEventListener("click", () =>
        copyText(els.cmdChat.value.split("\n\ncmd.exe:\n")[1] || ""),
      );

      // Header links: show help when served by the UI server.
      if (IS_SERVER) {
        if (headerEls.offlineHint)
          headerEls.offlineHint.textContent =
            "Offline config (served by local UI server)";

        if (keysUi.loadEnvBtn) keysUi.loadEnvBtn.style.display = "inline";
      }

      // Offline "browse" helpers
      if (els.questionFile)
        els.questionFile.addEventListener("change", () => pickFile("question"));
      if (els.baselineNetlistFile)
        els.baselineNetlistFile.addEventListener("change", () =>
          pickFile("baselineNetlist"),
        );
      if (els.baselineImageFile)
        els.baselineImageFile.addEventListener("change", () =>
          pickFile("baselineImage"),
        );
      if (els.questionClearBtn)
        els.questionClearBtn.addEventListener("click", () =>
          clearPicked("question"),
        );
      if (els.baselineNetlistClearBtn)
        els.baselineNetlistClearBtn.addEventListener("click", () =>
          clearPicked("baselineNetlist"),
        );
      if (els.baselineImageClearBtn)
        els.baselineImageClearBtn.addEventListener("click", () =>
          clearPicked("baselineImage"),
        );

      // API keys modal
      const keysOpenBtn = document.getElementById("keysOpenBtn");
      if (keysOpenBtn)
        keysOpenBtn.addEventListener("click", () => openKeysModal());
      if (els.openaiKeyBtn)
        els.openaiKeyBtn.addEventListener("click", () =>
          openKeysModal("openai"),
        );
      if (els.xaiKeyBtn)
        els.xaiKeyBtn.addEventListener("click", () => openKeysModal("xai"));
      if (els.geminiKeyBtn)
        els.geminiKeyBtn.addEventListener("click", () =>
          openKeysModal("gemini"),
        );
      if (els.anthropicKeyBtn)
        els.anthropicKeyBtn.addEventListener("click", () =>
          openKeysModal("anthropic"),
        );
      if (keysUi.closeBtn)
        keysUi.closeBtn.addEventListener("click", closeKeysModal);
      if (keysUi.modal)
        keysUi.modal.addEventListener("click", (e) => {
          if (e && e.target === keysUi.modal) closeKeysModal();
        });
      if (keysUi.saveBtn) keysUi.saveBtn.addEventListener("click", saveKeys);
      if (keysUi.loadEnvBtn)
        keysUi.loadEnvBtn.addEventListener("click", loadKeysFromEnv);
      if (keysUi.clearBtn) keysUi.clearBtn.addEventListener("click", clearKeys);

      if (keysUi.browseEnvFileBtn && keysUi.envFileInput) {
        keysUi.browseEnvFileBtn.addEventListener("click", () => {
          try {
            keysUi.envFileInput.click();
          } catch {
            // ignore
          }
        });
        keysUi.envFileInput.addEventListener("change", async () => {
          const f =
            keysUi.envFileInput &&
            keysUi.envFileInput.files &&
            keysUi.envFileInput.files[0];
          if (!f) return;
          await loadKeysFromLocalEnvFile(f);
          // Allow re-selecting the same file.
          try {
            keysUi.envFileInput.value = "";
          } catch {
            // ignore
          }
        });
      }
      setPasswordToggle(keysUi.showOpenai, keysUi.envOpenai);
      setPasswordToggle(keysUi.showXai, keysUi.envXai);
      setPasswordToggle(keysUi.showGemini, keysUi.envGemini);
      setPasswordToggle(keysUi.showAnthropic, keysUi.envAnthropic);

      // Load previously saved keys/config
      loadKeys();

      // Theme
      loadTheme();
      if (headerEls.themeSelect) {
        headerEls.themeSelect.addEventListener("change", () => {
          saveTheme(headerEls.themeSelect.value);
        });
      }

      updatePreview();
    </script>
  </body>
</html>
